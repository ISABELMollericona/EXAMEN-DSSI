<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Frontend Registro de Notas</title>
    
</head>
<body>
    <h1>Registro de Notas (Frontend HTML)</h1>
    <form id="notaForm">
        <label>Estudiante:
            <select id="estudianteSelect" name="estudiante_id"></select>
        </label>
        <label>Materia:
            <select id="materiaSelect" name="materia_id"></select>
        </label>
        <label>Nota:
            <input type="number" name="nota" min="0" max="100" step="0.01" required>
        </label>
        <button type="submit">Registrar Nota</button>
        <div id="notaMsg"></div>
    </form>
    <h2>Notas por estudiante</h2>
    <form id="consultaForm">
        <label>Estudiante:
            <select id="consultaEstudianteSelect" name="id"></select>
        </label>
        <button type="submit">Ver notas</button>
    </form>
    <div id="notasResult"></div>
    <script>
 
    async function cargarDatos() {
        const estRes = await fetch('/estudiantes');
        const estudiantes = await estRes.json();
        const matRes = await fetch('/materias');
        const materias = await matRes.json();
        const estSelect = document.getElementById('estudianteSelect');
        const matSelect = document.getElementById('materiaSelect');
        const consultaEstSelect = document.getElementById('consultaEstudianteSelect');
        estSelect.innerHTML = '';
        consultaEstSelect.innerHTML = '';
        estudiantes.forEach(e => {
            estSelect.innerHTML += `<option value="${e[0]}">${e[1]}</option>`;
            consultaEstSelect.innerHTML += `<option value="${e[0]}">${e[1]}</option>`;
        });
        matSelect.innerHTML = '';
        materias.forEach(m => {
            matSelect.innerHTML += `<option value="${m[0]}">${m[1]}</option>`;
        });
    }
    cargarDatos();


    document.getElementById('notaForm').onsubmit = async function(e) {
        e.preventDefault();
        const estudiante_id = document.getElementById('estudianteSelect').value;
        const materia_id = document.getElementById('materiaSelect').value;
        const nota = this.nota.value;
        const res = await fetch('/notas', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ estudiante_id, materia_id, nota })
        });
        const data = await res.json();
        document.getElementById('notaMsg').innerHTML = data.message ? data.message : `<span class="error">${data.error}</span>`;
    };

 
    document.getElementById('consultaForm').onsubmit = async function(e) {
        e.preventDefault();
        const id = document.getElementById('consultaEstudianteSelect').value;
        const res = await fetch(`/notas/estudiante/${id}`);
        const data = await res.json();
        let html = '<table><tr><th>Materia</th><th>Nota</th></tr>';
        data.notas.forEach(n => {
            html += `<tr><td>${n[1]}</td><td>${n[0]}</td></tr>`;
        });
        html += '</table>';
        html += `<strong>Promedio: ${data.promedio !== null ? data.promedio.toFixed(2) : 'N/A'}</strong>`;
        document.getElementById('notasResult').innerHTML = html;
    };
    </script>
</body>
</html>
